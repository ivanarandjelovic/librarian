<project name="librarian_db" basedir=".." xmlns:ivy="antlib:org.apache.ivy.ant" xmlns:ac="antlib:net.sf.antcontrib">
	<description>
		Database related build tasks for librarian
	</description>

	<taskdef resource="net/sf/antcontrib/antcontrib.properties" />
	
	<!-- Import common defintions -->
	<import file="./build_common.xml"/>

	<!-- set global properties for this build -->
	<property file="${build.dir}/build.properties"/>

	<!-- set database properties (used in sql statements and in build) -->
	<property file="${config.dir}/${db.configuration}/db.properties"/>

	<target name="db_create_user" description="create user, intended to be run manually, only once">
		<sql driver="com.mysql.jdbc.Driver" url="${db.root.url}" classpathref="run.app.path.id" userid="${db.root.user}" password="${db.root.password}" src="${db.dir}/create_user.sql" />
	</target>

	<target name="db_drop_user" description="drop user, intended to be run manually, only when needed">
		<sql driver="com.mysql.jdbc.Driver" url="${db.root.url}" classpathref="run.app.path.id" userid="${db.root.user}" password="${db.root.password}" src="${db.dir}/drop_user.sql" />
	</target>
	
 	<target name="db_drop_database" description="drop database">
		<sql driver="com.mysql.jdbc.Driver" url="${db.root.url}" classpathref="run.app.path.id" userid="${db.root.user}" password="${db.root.password}" src="${db.dir}/drop_database.sql" onerror="continue"/>
	</target>

	<target name="db_create_database" description="create database, expects that DB user already exists">
		<sql driver="com.mysql.jdbc.Driver" url="${db.root.url}" classpathref="run.app.path.id" userid="${db.root.user}" password="${db.root.password}" src="${db.dir}/create_database.sql" />
	</target>


	<target name="db_create_all" description="create all database objects from scratch">
		<echo message="Creating all DB objects for db.configuration=${db.configuration}" />
		<antcall target="db_drop_database"/>
		<antcall target="db_create_database"/>
		
		<!-- Iterate and execute each table file -->
		<loadfile property="table-files" srcFile="${db.dir}/all_tables.sql"/>

		<ac:for param="file" list="${table-files}" delimiter="${line.separator}">
			<sequential>
				<sql driver="com.mysql.jdbc.Driver" url="${db.url}" classpathref="run.app.path.id" userid="${db.user}" password="${db.password}" src="${db.dir}/@{file}" />
			</sequential>
		</ac:for>
	</target>


</project>